<?xml version="1.0" encoding="utf-8"?>
<Project>
  <UsingTask TaskName="Xamarin.Android.Tasks.CompileNativeAssembly" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GenerateJniRemappingNativeCode" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.LinkApplicationSharedLibraries" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.PrepareAbiItems" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.GenerateAssemblyBlobDSO" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />
  <UsingTask TaskName="Xamarin.Android.Tasks.PrepareAssemblyBlobItems" AssemblyFile="$(_XamarinAndroidBuildTasksAssembly)" />

  <PropertyGroup>
    <_AndroidUseAssemblySharedLibraries Condition=" '$(EmbedAssembliesIntoApk)' != 'true' or '$(AndroidIncludeDebugSymbols)' == 'true' ">false</_AndroidUseAssemblySharedLibraries>
    <_AndroidUseAssemblySharedLibraries Condition=" '$(_AndroidUseAssemblySharedLibraries)' == '' ">true</_AndroidUseAssemblySharedLibraries>

    <_AndroidApplicationSharedLibraryPath>$(IntermediateOutputPath)app_shared_libraries\</_AndroidApplicationSharedLibraryPath>
    <_CompressedAssembliesOutputDir>$(IntermediateOutputPath)android\lz4-2</_CompressedAssembliesOutputDir>

    <_AndroidKeepStandaloneAssemblySources Condition=" '$(_AndroidKeepStandaloneAssemblySources)' == '' ">false</_AndroidKeepStandaloneAssemblySources>
  </PropertyGroup>

  <!-- Native code preparation targets -->
  <Target Name="_PrepareNativeAssemblySources">
    <PrepareAbiItems
        BuildTargetAbis="@(_BuildTargetAbis)"
        NativeSourcesDir="$(_NativeAssemblySourceDir)"
        InstantRunEnabled="$(_InstantRunEnabled)"
        Debug="$(AndroidIncludeDebugSymbols)"
        Mode="typemap">
      <Output TaskParameter="AssemblySources" ItemName="_TypeMapAssemblySource" />
      <Output TaskParameter="AssemblyIncludes" ItemName="_TypeMapAssemblyInclude" />
    </PrepareAbiItems>

    <PrepareAbiItems
        BuildTargetAbis="@(_BuildTargetAbis)"
        NativeSourcesDir="$(_NativeAssemblySourceDir)"
        InstantRunEnabled="$(_InstantRunEnabled)"
        Debug="$(AndroidIncludeDebugSymbols)"
        Mode="marshal_methods">
      <Output TaskParameter="AssemblySources" ItemName="_MarshalMethodsAssemblySource" />
    </PrepareAbiItems>
  </Target>

  <Target Name="_PrepareEnvironmentAssemblySources">
    <PrepareAbiItems
        BuildTargetAbis="@(_BuildTargetAbis)"
        NativeSourcesDir="$(_NativeAssemblySourceDir)"
        InstantRunEnabled="$(_InstantRunEnabled)"
        Debug="$(AndroidIncludeDebugSymbols)"
        Mode="environment">
      <Output TaskParameter="AssemblySources" ItemName="_EnvironmentAssemblySource" />
    </PrepareAbiItems>
  </Target>

  <Target Name="_PrepareAssemblyDSOSources">
    <PrepareAbiItems
        BuildTargetAbis="@(_BuildTargetAbis)"
        NativeSourcesDir="$(_NativeAssemblySourceDir)"
        InstantRunEnabled="$(_InstantRunEnabled)"
        Debug="$(AndroidIncludeDebugSymbols)"
        Mode="assembly_dsos">
      <Output TaskParameter="AssemblySources" ItemName="_AssemblyDSOSource" />
    </PrepareAbiItems>
  </Target>

  <Target Name="_PrepareAndroidRemapNativeAssemblySources">
    <PrepareAbiItems
        BuildTargetAbis="@(_BuildTargetAbis)"
        NativeSourcesDir="$(_NativeAssemblySourceDir)"
        InstantRunEnabled="$(_InstantRunEnabled)"
        Debug="$(AndroidIncludeDebugSymbols)"
        Mode="jniremap">
      <Output TaskParameter="AssemblySources" ItemName="_AndroidRemapAssemblySource" />
    </PrepareAbiItems>
  </Target>

  <Target Name="_PrepareNativeAssemblyItems" DependsOnTargets="_GenerateJavaStubs">
    <ItemGroup>
      <_NativeAssemblyTarget Include="@(_TypeMapAssemblySource->'$([System.IO.Path]::ChangeExtension('%(Identity)', '.o'))')">
        <abi>%(_TypeMapAssemblySource.abi)</abi>
      </_NativeAssemblyTarget>

      <_NativeAssemblyTarget Include="@(_EnvironmentAssemblySource->'$([System.IO.Path]::ChangeExtension('%(Identity)', '.o'))')">
        <abi>%(_EnvironmentAssemblySource.abi)</abi>
      </_NativeAssemblyTarget>

      <_NativeAssemblyTarget Include="@(_MarshalMethodsAssemblySource->'$([System.IO.Path]::ChangeExtension('%(Identity)', '.o'))')">
        <abi>%(_MarshalMethodsAssemblySource.abi)</abi>
      </_NativeAssemblyTarget>

      <_NativeAssemblyTarget Include="@(_AndroidRemapAssemblySource->'$([System.IO.Path]::ChangeExtension('%(Identity)', '.o'))')">
        <abi>%(_AndroidRemapAssemblySource.abi)</abi>
      </_NativeAssemblyTarget>

      <_NativeAssemblyTarget Include="@(_AssemblyDSOSource->'$([System.IO.Path]::ChangeExtension('%(Identity)', '.o'))')">
        <abi>%(_AssemblyDSOSource.abi)</abi>
      </_NativeAssemblyTarget>
    </ItemGroup>
  </Target>

  <Target Name="_PrepareApplicationSharedLibraryItems">
    <ItemGroup>
      <_ApplicationSharedLibrary Include="$(_AndroidApplicationSharedLibraryPath)%(_BuildTargetAbis.Identity)\libxamarin-app.so">
        <abi>%(_BuildTargetAbis.Identity)</abi>
      </_ApplicationSharedLibrary>
    </ItemGroup>
  </Target>

  <Target Name="_PrepareAssemblyBlobItems">
    <PrepareAssemblyBlobItems
        AndroidBinUtilsDirectory="$(AndroidBinUtilsDirectory)"
        SharedLibraryOutputPath="$(_AndroidApplicationSharedLibraryPath)"
        SupportedAbis="@(_BuildTargetAbis)">
      <Output TaskParameter="AssemblyBlobDSOs" ItemName="_AndroidAssemblyBlobDSO" />
    </PrepareAssemblyBlobItems>
  </Target>

  <!-- Native source code generation targets -->
  <Target Name="_GenerateAssemblyBlobDSOs"
          DependsOnTargets="_PrepareNativeAssemblyItems;_PrepareAssemblyBlobItems"
          Inputs="@(_ResolvedUserAssemblies);@(_ResolvedFrameworkAssemblies);@(_AndroidResolvedSatellitePaths)"
          Outputs="@(_AndroidAssemblyBlobDSO);@(_AssemblyDSOSource)">
    <GenerateAssemblyBlobDSO
        Assemblies="@(_ResolvedUserAssemblies);@(_ResolvedFrameworkAssemblies);@(_AndroidResolvedSatellitePaths)"
        AssemblyBlobDSOs="@(_AndroidAssemblyBlobDSO)"
        CompressedAssembliesOutputDirectory="$(_CompressedAssembliesOutputDir)"
        EnableCompression="$(AndroidEnableAssemblyCompression)"
        SourcesOutputDirectory="$(_NativeAssemblySourceDir)">
    </GenerateAssemblyBlobDSO>

    <ItemGroup>
      <FileWrites Include="@(_AndroidAssemblyBlobDSO);@(_AssemblyDSOSource)" />
    </ItemGroup>
  </Target>

  <Target Name="_GenerateEmptyAndroidRemapNativeCode"
          DependsOnTargets="_PrepareAndroidRemapNativeAssemblySources"
          Condition=" '@(_AndroidRemapMembers->Count())' == '0' "
          Inputs="$(MSBuildProjectFullPath)"
          Outputs="@(_AndroidRemapAssemblySource)">
    <GenerateJniRemappingNativeCode
        OutputDirectory="$(_NativeAssemblySourceDir)"
        GenerateEmptyCode="True"
        SupportedAbis="@(_BuildTargetAbis)"
        />
  </Target>

  <Target Name="_GenerateAndroidRemapNativeCode"
          DependsOnTargets="$(_GenerateAndroidRemapNativeCodeDependsOn)"
          Condition=" '@(_AndroidRemapMembers->Count())' != '0' "
          Inputs="$(_XARemapMembersFilePath)"
          Outputs="@(_AndroidRemapAssemblySource)">
    <GenerateJniRemappingNativeCode
        OutputDirectory="$(_NativeAssemblySourceDir)"
        RemappingXmlFilePath="$(_XARemapMembersFilePath)"
        SupportedAbis="@(_BuildTargetAbis)"
        />
  </Target>

  <!-- Native code compilation targets -->
  <Target Name="_CompileApplicationNativeAssemblySources"
          DependsOnTargets="_PrepareNativeAssemblyItems"
          Inputs="@(_TypeMapAssemblySource);@(_TypeMapAssemblyInclude);@(_EnvironmentAssemblySource);@(_MarshalMethodsAssemblySource);@(_AndroidRemapAssemblySource);@(_AssemblyDSOSource)"
          Outputs="@(_NativeAssemblyTarget)">
    <CompileNativeAssembly
        Sources="@(_TypeMapAssemblySource);@(_EnvironmentAssemblySource);@(_MarshalMethodsAssemblySource);@(_AndroidRemapAssemblySource);@(_AssemblyDSOSource)"
        DebugBuild="$(AndroidIncludeDebugSymbols)"
        WorkingDirectory="$(_NativeAssemblySourceDir)"
        AndroidBinUtilsDirectory="$(AndroidBinUtilsDirectory)"
        />
    <ItemGroup>
      <FileWrites Include="@(_NativeAssemblyTarget)" />
    </ItemGroup>
  </Target>

  <!-- Shared library creation targets -->
  <PropertyGroup>
    <!-- Order of targets is **crucial** here -->
    <_CreateApplicationSharedLibrariesDependsOn>
      _PrepareAssemblyDSOSources;
      _GenerateAssemblyBlobDSOs;
      _CompileApplicationNativeAssemblySources;
      _PrepareApplicationSharedLibraryItems
    </_CreateApplicationSharedLibrariesDependsOn>
  </PropertyGroup>

  <Target Name="_CreateApplicationSharedLibraries"
          DependsOnTargets="$(_CreateApplicationSharedLibrariesDependsOn)"
          Inputs="@(_NativeAssemblyTarget);@(_StandaloneAssemblyDSO)"
          Outputs="@(_ApplicationSharedLibrary)">
    <LinkApplicationSharedLibraries
        ObjectFiles="@(_NativeAssemblyTarget)"
        ApplicationSharedLibraries="@(_ApplicationSharedLibrary)"
        DebugBuild="$(AndroidIncludeDebugSymbols)"
        AndroidBinUtilsDirectory="$(AndroidBinUtilsDirectory)"
    />
    <ItemGroup>
      <FileWrites Include="@(_ApplicationSharedLibrary)" />
    </ItemGroup>
  </Target>
</Project>
